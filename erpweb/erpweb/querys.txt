USE [dilaco]
GO
/****** Object:  StoredProcedure [dbo].[web_carga_nv_det_web]    Script Date: 28/09/2020 18:17:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[web_carga_cot_det_web]
	@v_id_cot int,
	@v_item int,
	@v_codigo nvarchar(30),
	@v_descripcion nvarchar(500),
	@v_cantidad float, 
	@v_precio_unitario float
AS
BEGIN TRY
   BEGIN TRAN
   declare @cmd nvarchar(500)
   declare @id_cliente int
   declare @id_contacto int
   declare @ctrl int
   declare @id_cot int
   declare @id_nta_vta int
   declare @_id_cotizacion int
   declare @nta_vta_num int
   declare @rut int
   declare @dv nvarchar(1)
   declare @v_id_item int
   declare @v_precio_lista float
   declare @v_ID_Item_Nta_Vta int
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	select @v_id_item = id_item from tbl_Items where Codigo = @v_codigo

	select @v_precio_lista = precio from tbl_Items where ID_Item = @v_id_item;

	select @_id_cotizacion= Id_Cotizacion from tbl_Items_Cotizacion where Id_Cotizacion = @v_id_cot

	if isnull(@_id_cotizacion,0) = 0
	begin
	INSERT INTO [dbo].[tbl_Items_Cotizacion]
			   ([Id_Cotizacion]
			   ,[Item]
			   ,[Id_Item]
			   ,[Codigo]
			   ,[Descripcion]
			   ,[Precio_Lista]
			   ,[Descuento]
			   ,[Valor_Unitario]
			   ,[Cantidad]
			   ,[Suma]
			   ,[Entrega]
			   ,[Id_Estado]
			   ,[Mostrar_Argum_Vta]
			   ,[Salto_Pagina]
			   ,[Sw_Precio_Especial])
		 VALUES
			   (@v_id_cot
			   ,@v_item
			   ,@v_id_item
			   ,@v_codigo
			   ,@v_descripcion
			   ,@v_precio_lista
			   ,0
			   ,@v_precio_unitario
			   ,@v_cantidad
			   ,(@v_precio_unitario * @v_cantidad)
			   ,NULL
			   ,NULL
			   ,1
			   ,0
			   ,0)

		select distinct  @v_ID_Item_Nta_Vta = ID_Item_Cotizacion  from tbl_Items_Cotizacion where Id_Cotizacion = @v_id_cot

	end
	select isnull(@v_ID_Item_Nta_Vta,0)
	COMMIT TRAN
END TRY

BEGIN CATCH
    ROLLBACK TRAN
	delete tbl_Cotizaciones where ID_Cotizacion = @v_id_cot
    select cast(ERROR_LINE() as nvarchar)+ ' '+ cast(ERROR_NUMBER() as nvarchar) + ' ' + ERROR_MESSAGE()
END CATCH;


USE [dilaco]
GO
/****** Object:  StoredProcedure [dbo].[web_carga_cot_cab_web]    Script Date: 28/09/2020 19:16:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[web_carga_cot_cab_web]
	@v_id_cot int,
	@v_ncot int,
	@v_fecha datetime,
	@v_obs nvarchar(500),
	@v_Id_cliente int, 
	@v_id_contacto int,
	@v_Suma_total float, 
	@v_Neto_venta float, 
	@v_Tax_venta float, 
	@v_total float,
	@v_sigla_moneda nvarchar(3),
	@v_id_vendedor int,
	@v_id_tipo_fact int
AS
BEGIN TRY
   BEGIN TRAN
   declare @cmd nvarchar(500)
   declare @id_cliente int
   declare @id_contacto int
   declare @ctrl int
   declare @id_cot int
   declare @id_nta_vta int
   declare @_id_cotizacion int
   declare @num_cotizacion int
   declare @rut int
   declare @dv nvarchar(1)
   declare @v_id_moneda int
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	select @v_id_moneda = ID_Moneda from tbl_monedas where sigla = trim(@v_sigla_moneda)

	select @_id_cotizacion = ID_Cotizacion from tbl_Cotizaciones where ID_Cotizacion_Web = @v_id_cot

	if isnull(@_id_cotizacion,0) = 0
	begin

		select @num_cotizacion = Correlativo_COT + 1 from tbl_Correlativos

		INSERT INTO [dbo].[tbl_Cotizaciones]
           ([Cotizac_Num]
           ,[Fecha_Cotizac]
           ,[Nombre_Cotizacion]
           ,[Observaciones]
           ,[Id_Tipo_Cotizacion]
           ,[Id_Estado]
           ,[Referencia]
           ,[Id_Cliente]
           ,[Id_Contacto]
           ,[Id_Vendedor]
           ,[Id_Autor]
           ,[Id_Filial]
           ,[Revisa_Cot_Num]
           ,[Condiciones_Vta]
           ,[Suma_Total]
           ,[Descuento_General]
           ,[Val_Descuento_General]
           ,[Descuento_Adicional]
           ,[Val_Descuento_Adicional]
           ,[Id_Moneda]
           ,[Neto_En_Moneda]
           ,[Cambio]
           ,[Mostrar_Cambio]
           ,[Neto_Venta]
           ,[Tax_venta]
           ,[Mostrar_Tax]
           ,[TOTAL]
           ,[Fecha_Reactivacion]
           ,[Verificada]
           ,[Fecha_Verificada]
           ,[Usr_Verifica]
           ,[Creado]
           ,[Usr_Crea]
           ,[Fecha_Impresa]
           ,[Usr_Imprime]
           ,[Solicita_Anular]
           ,[Motivo_Solicita_Anular]
           ,[Fecha_Solicita_Anular]
           ,[Usr_Solicita_Anular]
           ,[Documento_Cotizacion]
           ,[Solicita_Reabrir]
           ,[Cot_Enviada_Mail]
           ,[Cot_Enviada_Mano]
           ,[Fecha_Envio]
           ,[Usr_Envia_Cot]
           ,[Con_Servicio]
		   ,ID_Cotizacion_Web
		   ,Cotizac_Num_Web)
		VALUES
           (@num_cotizacion
           ,@v_fecha
           ,concat('Cotización Web N°', @v_ncot)
           ,@v_obs
           ,6 -- Web
           ,1 -- Preparándose
           ,''
           ,@v_Id_cliente
           ,@v_id_contacto
           ,@v_id_vendedor
           ,2
           ,1 -- Filia
           ,@num_cotizacion
           ,''
           ,@v_Suma_total
           ,0
           ,0
           ,0
           ,0
           ,@v_id_moneda
           ,@v_Neto_venta
           ,0
           ,0
           ,@v_Neto_venta
           ,@v_Tax_venta
           ,1
           ,@v_Suma_total
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,GETDATE()
           ,2
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,0
           ,0
           ,0
           ,NULL
           ,0
		   ,@v_id_cot
		   ,@v_ncot)

		-- cabecera cotización
		-- detalle cotización
		update tbl_Correlativos set Correlativo_COT = Correlativo_COT + 1
		select @_id_cotizacion = ID_Cotizacion from tbl_Cotizaciones where ID_Cotizacion_Web = @v_id_cot
	end
	select @_id_cotizacion
	COMMIT TRAN
END TRY

BEGIN CATCH
    ROLLBACK TRAN
    select cast(ERROR_LINE() as nvarchar)+ ' '+ cast(ERROR_NUMBER() as nvarchar) + ' ' + ERROR_MESSAGE()
END CATCH;
